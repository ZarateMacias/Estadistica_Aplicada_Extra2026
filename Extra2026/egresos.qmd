---
title: "Análisis Estadístico de las Finanzas Públicas Estatales en México: Egresos"
subtitle: "Estadística de Finanzas Públicas Estatales y Municipales (EFIPEM) 2013-2023"
lang: es
format:
  html:
    toc: false
    theme: cosmo
    code-fold: true
    fig-width: 8
    fig-height: 6
    fig-align: "center"
    fontsize: 1.1rem
---

```{=html}
<style>
main.content {
text-align: justify}
</style>
```

```{r}
#| code-fold: true
#| message: false
#| warning: false

library(tidyverse)
library(RColorBrewer)
library(sf)          # Para datos espaciales
library(viridis)     # Para paletas de colores
library(DT)
library(plotly)
library(knitr)
library(kableExtra)
library(corrplot)
library(broom)
library(scales)
library(multcomp)
```

## Marco Conceptual de la EFIPEM

La **Estadística de Finanzas Públicas Estatales y Municipales (EFIPEM)** es un proyecto estadístico del Instituto Nacional de Estadística y Geografía (INEGI) que tiene como objetivo integrar información sobre el origen y aplicación de los recursos financieros de los gobiernos estatales y municipales en México. A continuación se hace una descripción de la estructura de los datos brindada en la [Síntesis metodológica de la estadística de finanzas públicas estatales y municipales](https://www.inegi.org.mx/app/biblioteca/ficha.html?upc=702825085926).

## Estructura de Clasificación de los Datos

La EFIPEM organiza la información financiera siguiendo una estructura jerárquica que permite un análisis detallado y homogéneo de las finanzas públicas:

### Niveles de Agregación

1.  **Tema**: Nivel más agregado que clasifica las operaciones en:

    -   **Ingresos**: Recursos captados por las entidades públicas
    -   **Egresos**: Recursos aplicados por las entidades públicas

2.  **Capítulo**: Cada tema se divide en 11 capítulos que agrupan operaciones de naturaleza similar

3.  **Concepto**: Subdivisión de los capítulos que especifica el tipo de operación

4.  **Partida**: Nivel de detalle que identifica el objeto específico del ingreso o gasto

5.  **Subpartida**: Mayor nivel de desagregación disponible

## Clasificación de Egresos Estatales

Según la metodología establecida por el INEGI en la EFIPEM, los egresos de los estados mexicanos se organizan en categorías que reflejan el destino y naturaleza del gasto público:

### Estructura General

| **Categoría Principal** | **Capítulos que la componen** |
|-------------------------------|:---------------------------------------|
| **Gastos Corrientes** | Servicios personales, Materiales y suministros, Servicios generales |
| **Transferencias y Asignaciones** | Transferencias, asignaciones, subsidios y otras ayudas, Recursos asignados a municipios |
| **Inversión y Desarrollo** | Inversión pública, Bienes muebles, inmuebles e intangibles |
| **Obligaciones Financieras** | Deuda pública, Inversiones financieras y otras provisiones |
| **Otros Egresos** | Otros egresos, Disponibilidad final |

### Gastos Corrientes

Los gastos corrientes representan los recursos destinados al funcionamiento operativo del gobierno estatal. Esta categoría incluye:

- **Servicios personales**: Remuneraciones al personal que presta sus servicios en las instituciones públicas estatales, incluyendo sueldos, salarios, prestaciones y seguridad social.
- **Materiales y suministros**: Adquisición de insumos y materiales necesarios para el desarrollo de las actividades administrativas y operativas.
- **Servicios generales**: Contratación de servicios que requieren las instituciones públicas para su operación, como servicios de mantenimiento, arrendamientos, servicios profesionales, entre otros.

### Transferencias y Asignaciones

Esta categoría comprende recursos que el gobierno estatal destina a otros órdenes de gobierno, sectores o instituciones:

- **Transferencias, asignaciones, subsidios y otras ayudas**: Recursos otorgados a diversos sectores de la población, instituciones o entidades sin contraprestación directa, como subsidios, ayudas sociales, becas y donativos.
- **Recursos asignados a municipios**: Transferencias que los gobiernos estatales realizan a los gobiernos municipales para fortalecer sus finanzas y capacidad de gestión.

### Inversión y Desarrollo

Representa el gasto destinado a la creación, ampliación y mejoramiento de la infraestructura estatal:

- **Inversión pública**: Recursos destinados a la construcción, ampliación, mantenimiento y conservación de obras públicas de infraestructura.
- **Bienes muebles, inmuebles e intangibles**: Adquisición de activos para el desempeño de las funciones públicas, incluyendo mobiliario, equipo, vehículos y bienes inmuebles.

### Obligaciones Financieras

Comprende el gasto relacionado con el manejo de la deuda y las obligaciones financieras del estado:

- **Deuda pública**: Recursos destinados al pago del principal e intereses de la deuda pública estatal, tanto interna como externa.
- **Inversiones financieras y otras provisiones**: Recursos destinados a la adquisición de valores, acciones y constitución de fondos y reservas.

### Otros Egresos

Incluye recursos de naturaleza diversa:

- **Otros egresos**: Gastos que no pueden clasificarse en las categorías anteriores.
- **Disponibilidad final**: Recursos no ejercidos al cierre del ejercicio fiscal que quedan disponibles para el siguiente periodo.

## Importancia en la Gestión Pública Estatal

La clasificación de egresos permite:

1. **Evaluar prioridades** del gasto público estatal
2. **Identificar la composición** entre gasto corriente y de inversión
3. **Analizar la capacidad de inversión** de cada entidad
4. **Monitorear el nivel de endeudamiento** estatal
5. **Comparar patrones de gasto** entre entidades federativas

Esta estructura facilita el análisis comparativo entre estados y la evaluación de la eficiencia en el uso de recursos públicos, permitiendo identificar áreas de oportunidad en la gestión financiera estatal.

## Objetivos del Análisis

El presente estudio tiene como objetivos:

1.  **Analizar la evolución de los egresos estatales** durante el período 2013-2023
2.  **Identificar patrones y tendencias** en las finanzas públicas estatales
3.  **Realizar análisis estadísticos descriptivos**
4.  **Aplicar pruebas de hipótesis** para evaluar diferencias significativas entre estados y años
5.  **Proporcionar hallazgos** sobre la gestión financiera estatal en México

## Cargar datos

Consideramos los datos de finanzas públicas de los estados de México, disponibles en varios archivos CSV dentro de la carpeta "conjunto_de_datos". No se consideran los valores de la Ciudad de México.

```{r}
#| code-fold: true
#| message: false
#| warning: false


# Se identifican los archivos CSV en el directorio especificado
data_sets <- list.files("./conjunto_de_datos", pattern = "*.csv", full.names = TRUE)

# Se leen y combinan los archivos CSV en un solo data frame
datos <- data_sets |> 
  set_names(nm = data_sets) |> 
  map_dfr(read_csv, .id = "source_file")

# Convertir variables de tipo character a factor
datos_factor <- datos |> 
  dplyr::select(where(is.character)) |> 
  names()

datos <- datos |> 
  mutate(across(all_of(datos_factor), as_factor))

# Crear variables adicionales
datos <- datos |> mutate(ANIO_factor = as_factor(ANIO), VALOR_millones = VALOR / 1e6)
datos <- datos |> rename(CVE_ENT = ID_ENTIDAD)

# Cargar datos de estados y unir con el conjunto de datos principal
datos_estado <- read_csv("./datos/tc_entidad.csv")
datos_estado <- datos_estado |> mutate(across(everything(), as_factor))
datos_estado$ZONA <- factor(datos_estado$ZONA, levels = c("NORTE", "CENTRO", "SUR"))

datos <- left_join(datos, datos_estado)

# Eliminar columnas no necesarias
datos <- datos |> dplyr::select(-source_file, -PROD_EST, -COBERTURA, -ESTATUS) 

#glimpse(datos)

nacional_estado <- st_read("data_nacional/00ent.shp", options = "ENCODING=LATIN1", quiet = TRUE)
nacional_estado <- left_join(nacional_estado, datos_estado, by = "CVE_ENT")

cat("Años disponibles:", paste(unique(datos$ANIO_factor), collapse = ", "), "\n")
cat("Entidades incluidas:", length(unique(datos$CVE_ENT)), "\n")
cat("Temas:", paste(unique(datos$TEMA), collapse = ", "), "\n")
cat("Categorías:", paste(unique(datos$CATEGORIA), collapse = ", "), "\n\n")

```

## Análisis Exploratorio de Datos: Egresos Nivel Capítulo

### Estructura General de los Egresos

-   Dataset `egresos`: Filtrado para el tema "Egresos" y categoría "Capítulo". Se agrega porcentaje anual de cada capítulo.
-   Dataset `egresos_agregados`: Agregado por año, estado y categoría principal con cálculos de porcentaje anual.
-   Dataset `egresos_wide`: Transformado a formato ancho con valores y porcentajes por categoría principal.

```{r}
#| code-fold: true

egresos <- datos |> filter(TEMA == "Egresos", CATEGORIA == "Capítulo")

# Agregar porcentaje anual al dataset original
egresos <- egresos |> 
  group_by(ANIO, CVE_ENT, NOM_ENT) |> 
  mutate(
    total_estado_anio = sum(VALOR_millones, na.rm = TRUE),
    porcentaje_anual = (VALOR_millones / total_estado_anio) * 100
  ) |> 
  ungroup()


# Definir niveles de categoría para egresos
niveles_categoria_egresos <- c("Servicios personales", "Materiales y suministros", 
                               "Servicios generales", "Transferencias, asignaciones, subsidios y otras ayudas",
                               "Bienes muebles, inmuebles e intangibles", "Inversión pública",
                               "Inversiones financieras y otras provisiones", "Recursos asignados a municipios",
                               "Otros egresos", "Deuda pública", "Disponibilidad final")

egresos$DESCRIPCION_CATEGORIA <- factor(egresos$DESCRIPCION_CATEGORIA, 
                                       levels = niveles_categoria_egresos)

# Agregar columna de categorías principales para egresos
egresos <- egresos |> 
  mutate(
    CATEGORIA_PRINCIPAL = case_when(
      # Gastos Corrientes
      DESCRIPCION_CATEGORIA %in% c("Servicios personales", "Materiales y suministros", 
                                  "Servicios generales") ~ "Gastos Corrientes",
      
      # Transferencias y Asignaciones
      DESCRIPCION_CATEGORIA %in% c("Transferencias, asignaciones, subsidios y otras ayudas",
                                  "Recursos asignados a municipios") ~ "Transferencias y Asignaciones",
      
      # Inversión y Desarrollo
      DESCRIPCION_CATEGORIA %in% c("Inversión pública", 
                                  "Bienes muebles, inmuebles e intangibles") ~ "Inversión y Desarrollo",
      
      # Obligaciones Financieras
      DESCRIPCION_CATEGORIA %in% c("Deuda pública", 
                                  "Inversiones financieras y otras provisiones") ~ "Obligaciones Financieras",
      
      # Otros Egresos
      DESCRIPCION_CATEGORIA %in% c("Otros egresos", "Disponibilidad final") ~ "Otros Egresos"
    ),
    
    # Convertir a factor con orden específico
    CATEGORIA_PRINCIPAL = factor(CATEGORIA_PRINCIPAL, 
                                levels = c("Gastos Corrientes", "Transferencias y Asignaciones",
                                          "Inversión y Desarrollo", "Obligaciones Financieras", 
                                          "Otros Egresos"))
  )




# Agregar datos por ANIO, Estado y CATEGORIA_PRINCIPAL con porcentajes
egresos_agregados <- egresos |> 
  group_by(ANIO, CVE_ENT, NOM_ENT, ABR_ENT, ZONA, CATEGORIA_PRINCIPAL, ANIO_factor) |> 
  summarise(
    VALOR = sum(VALOR, na.rm = TRUE),
    VALOR_millones = sum(VALOR_millones, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  # Calcular porcentaje por estado y año
  group_by(ANIO, CVE_ENT, NOM_ENT) |> 
  mutate(
    total_estado_anio = sum(VALOR_millones, na.rm = TRUE),
    porcentaje_anual = (VALOR_millones / total_estado_anio) * 100
  ) |> 
  ungroup() |> 
  # Reordenar columnas para mantener estructura similar
  dplyr::select(
    ANIO,
    CVE_ENT, 
    VALOR,
    ANIO_factor,
    VALOR_millones,
    porcentaje_anual,
    NOM_ENT,
    ABR_ENT,
    ZONA,
    CATEGORIA_PRINCIPAL
  )


# Transformar a formato ancho con valor y porcentaje por categoría
egresos_wide <- egresos_agregados |> 
  dplyr::select(ANIO, CVE_ENT, ANIO_factor, NOM_ENT, ABR_ENT, ZONA, 
         CATEGORIA_PRINCIPAL, VALOR_millones, porcentaje_anual) |> 
  pivot_wider(
    names_from = CATEGORIA_PRINCIPAL,
    values_from = c(VALOR_millones, porcentaje_anual),
    names_sep = "_"
  ) |> 
  rename_with(
    ~ case_when(
      .x == "VALOR_millones_Gastos Corrientes" ~ "Gastos_Corrientes_valor",
      .x == "porcentaje_anual_Gastos Corrientes" ~ "Gastos_Corrientes_porcentaje",
      .x == "VALOR_millones_Transferencias y Asignaciones" ~ "Transferencias_Asignaciones_valor",
      .x == "porcentaje_anual_Transferencias y Asignaciones" ~ "Transferencias_Asignaciones_porcentaje",
      .x == "VALOR_millones_Inversión y Desarrollo" ~ "Inversion_Desarrollo_valor",
      .x == "porcentaje_anual_Inversión y Desarrollo" ~ "Inversion_Desarrollo_porcentaje",
      .x == "VALOR_millones_Obligaciones Financieras" ~ "Obligaciones_Financieras_valor",
      .x == "porcentaje_anual_Obligaciones Financieras" ~ "Obligaciones_Financieras_porcentaje",
      .x == "VALOR_millones_Otros Egresos" ~ "Otros_Egresos_valor",
      .x == "porcentaje_anual_Otros Egresos" ~ "Otros_Egresos_porcentaje",
      TRUE ~ .x
    )
  ) |> 
  # Reemplazar NA con 0 donde sea apropiado
  mutate(
    across(contains("_valor"), ~ replace_na(.x, 0)),
    across(contains("_porcentaje"), ~ replace_na(.x, 0))
  ) |> 
  # Reordenar columnas
  dplyr::select(
    ANIO, CVE_ENT, ANIO_factor, NOM_ENT, ABR_ENT, ZONA,
    Gastos_Corrientes_valor, Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_valor, Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_valor, Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_valor, Obligaciones_Financieras_porcentaje,
    Otros_Egresos_valor, Otros_Egresos_porcentaje
  )

cat("Capítulos presentes: ", paste(levels(egresos$DESCRIPCION_CATEGORIA), collapse = ", \n"))

# Tabla resumen
resumen_estructura <- egresos |> group_by(TEMA, CATEGORIA, ABR_ENT) |> 
  summarise(
    registros = n(),
    valor_total = sum(VALOR, na.rm = TRUE)/ 1e9,  # En miles de millones
    .groups = "drop"
  ) |> 
  arrange(TEMA, CATEGORIA, ABR_ENT)

kable(resumen_estructura, 
      col.names = c("Tema", "Categoría", "Entidad", "Registros", "Total (Miles Mill. MXN)"),
      digits = 2,
      caption = "Estructura General de Egresos EFIPEM 2014-2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


```

## Mapas de Egresos Totales por Estado

```{r}
#| code-fold: true

agregado_mapa_egresos <- resumen_estructura |> 
  dplyr::select(ABR_ENT, valor_total)
agregado_mapa_egresos <- left_join(nacional_estado, agregado_mapa_egresos, by = "ABR_ENT")

mapa_egresos <- ggplot(agregado_mapa_egresos) +
  geom_sf(aes(fill = valor_total), color = "gray50", size = 0.5) +
  labs(
    title = "Egresos totales por estado (2013-2023)",
    subtitle = "Valores en miles de millones de MXN",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "Egresos Totales"
  ) +
  scale_fill_viridis_c(labels = comma) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

print(mapa_egresos)
```

Sin el Estado de México para una mejor visualización:

```{r}
#| code-fold: true

mapa_egresos_sin_mex <- ggplot(agregado_mapa_egresos |> filter(ABR_ENT != "MEX")) +
  geom_sf(aes(fill = valor_total), color = "gray50", size = 0.5) +
  labs(
    title = "Egresos totales por estado (2013-2023)",
    subtitle = "Valores en miles de millones de MXN (sin Estado de México)",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "Egresos Totales"
  ) +
  scale_fill_viridis_c(labels = comma) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

print(mapa_egresos_sin_mex)
```
## Composición de Egresos por Estado (2013-2023)
```{r}
#| code-fold: true
#| fig-width: 10
#| fig-height: 10
#| fig-align: "center"

# Calcular porcentajes de cada categoría por estado
porcentajes_categoria_estado_egresos <- egresos |> 
  group_by(NOM_ENT, ABR_ENT, DESCRIPCION_CATEGORIA) |> 
  summarise(valor_categoria = sum(VALOR_millones, na.rm = TRUE), .groups = "drop") |> 
  group_by(NOM_ENT, ABR_ENT) |> 
  mutate(
    total_estado = sum(valor_categoria),
    porcentaje = (valor_categoria / total_estado) * 100
  ) %>%
  ungroup()

# Con etiquetas de porcentaje (solo categorías >5%)
graf_bar_egresos <- porcentajes_categoria_estado_egresos |> 
  mutate(etiqueta = ifelse(porcentaje >= 5, 
                          paste0(round(porcentaje, 1), "%"), 
                          "")) |> 
  ggplot(aes(x = reorder(ABR_ENT, total_estado), 
             y = porcentaje, 
             fill = DESCRIPCION_CATEGORIA)) +
  geom_col(position = "stack") +
  geom_text(aes(label = etiqueta), 
            position = position_stack(vjust = 0.5),
            size = 4, 
            color = "white",
            fontface = "bold") +
  coord_flip() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = "Composición de Egresos por Estado",
    subtitle = "Porcentaje por categoría (etiquetas >5%)",
    x = "Estado",
    y = "Porcentaje (%)",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE))

graf_bar_egresos
```

### Mapa Gastos Corrientes por estado (2013-2023)
```{r}
#| code-fold: true
#| fig-width: 8
#| fig-height: 6
#| fig-align: "center"
#| message: false

gastos_corrientes_mapa <- porcentajes_categoria_estado_egresos |> 
  filter(DESCRIPCION_CATEGORIA == "Servicios personales") 

gastos_corrientes_mapa <- left_join(nacional_estado, gastos_corrientes_mapa)

mapa_gastos_corrientes <- ggplot(gastos_corrientes_mapa) +
  geom_sf(aes(fill=valor_categoria), color = "gray50", size = 0.5) +
  labs(
    title = "Servicios Personales en Egresos Totales (2013-2023)",
    subtitle = "En millones de MXN",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "S. Personales"
  ) +
  scale_fill_viridis_c() +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

mapa_gastos_corrientes
```

Sin el Estado de México.
```{r}
#| code-fold: true
#| fig-width: 8
#| fig-height: 6
#| fig-align: "center"

mapa_gastos_corrientes <- ggplot(gastos_corrientes_mapa |> filter(ABR_ENT != "MEX")) +
  geom_sf(aes(fill=valor_categoria), color = "gray50", size = 0.5) +
  labs(
    title = "Servicios Personales en Egresos Totales (2013-2023)",
    subtitle = "En millones de MXN (sin Estado de México)",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "S. Personales"
  ) +
  scale_fill_viridis_c() +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

mapa_gastos_corrientes
```
```{r}
#| code-fold: true
#| fig-width: 8
#| fig-height: 6
#| fig-align: "center"

mapa_gastos_corrientes_pct <- ggplot(gastos_corrientes_mapa) +
  geom_sf(aes(fill=porcentaje), color = "gray50", size = 0.5) +
  labs(
    title = "Servicios Personales en Egresos Totales (2013-2023)",
    subtitle = "Porcentaje del total de egresos",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "S. Personales"
  ) +
  scale_fill_viridis_c(labels = percent_format(scale = 1)) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

mapa_gastos_corrientes_pct
```

# Egresos por Categoría Principal (2013-2023)
```{r}
#| code-fold: true

# Tabla con valores y porcentajes por CATEGORIA_PRINCIPAL
tabla_resumen_principal_egresos <- egresos |> 
  group_by(CATEGORIA_PRINCIPAL) |> 
  summarise(
    valor_millones = sum(VALOR_millones, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    porcentaje = (valor_millones / sum(valor_millones)) * 100,
    valor_billones = valor_millones / 1000000
  ) |> 
  arrange(desc(valor_millones))

# Mostrar tabla formateada
tabla_resumen_principal_egresos %>%
  mutate(
    `Valor (Millones MXN)` = format(round(valor_millones, 0), big.mark = ",", scientific = FALSE),
    `Valor (Billones MXN)` = format(round(valor_billones, 2), nsmall = 2),
    `Porcentaje (%)` = format(round(porcentaje, 1), nsmall = 1)
  ) %>%
  dplyr::select(
    `Categoría Principal` = CATEGORIA_PRINCIPAL,
    `Valor (Millones MXN)`,
    `Valor (Billones MXN)`,
    `Porcentaje (%)`
  ) %>%
  kable(
    caption = "Egresos Estatales por Categoría Principal (2013-2023)",
    align = c("l", "r", "r", "r")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 12
  ) %>%
  add_header_above(c(" " = 1, "Valores Absolutos" = 2, "Relativo" = 1))
```

## Tendencias Temporales por Categoría Principal

A continuación, se presentan las tendencias temporales de los egresos estatales desglosados por categoría principal para el periodo 2013-2023.

::: panel-tabset
### Gastos Corrientes
```{r}
#| code-fold: true

graf_temp_egresos <- ggplot(egresos_agregados |> filter(CATEGORIA_PRINCIPAL == "Gastos Corrientes"), 
                    aes(x = ANIO, y = VALOR_millones, color = ABR_ENT)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = unique(egresos_agregados$ANIO)) +
  labs(
    title = "Tendencias Temporales de Egresos Estatales: Gastos Corrientes (2013-2023)",
    x = "Año",
    y = "Egresos (Millones MXN)",
    color = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  )

ggplotly(graf_temp_egresos)
```

### Transferencias y Asignaciones
```{r}
#| code-fold: true

graf_temp_egresos2 <- ggplot(egresos_agregados |> filter(CATEGORIA_PRINCIPAL == "Transferencias y Asignaciones"), 
                    aes(x = ANIO, y = VALOR_millones, color = ABR_ENT)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = unique(egresos_agregados$ANIO)) +
  labs(
    title = "Tendencias Temporales de Egresos Estatales: Transferencias y Asignaciones (2013-2023)",
    x = "Año",
    y = "Egresos (Millones MXN)",
    color = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  )

ggplotly(graf_temp_egresos2)
```

### Inversión y Desarrollo
```{r}
#| code-fold: true

graf_temp_egresos3 <- ggplot(egresos_agregados |> filter(CATEGORIA_PRINCIPAL == "Inversión y Desarrollo"), 
                    aes(x = ANIO, y = VALOR_millones, color = ABR_ENT)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = unique(egresos_agregados$ANIO)) +
  labs(
    title = "Tendencias Temporales de Egresos Estatales: Inversión y Desarrollo (2013-2023)",
    x = "Año",
    y = "Egresos (Millones MXN)",
    color = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  )

ggplotly(graf_temp_egresos3)
```

### Obligaciones Financieras
```{r}
#| code-fold: true

graf_temp_egresos4 <- ggplot(egresos_agregados |> filter(CATEGORIA_PRINCIPAL == "Obligaciones Financieras"), 
                    aes(x = ANIO, y = VALOR_millones, color = ABR_ENT)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = unique(egresos_agregados$ANIO)) +
  labs(
    title = "Tendencias Temporales de Egresos Estatales: Obligaciones Financieras (2013-2023)",
    x = "Año",
    y = "Egresos (Millones MXN)",
    color = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  )

ggplotly(graf_temp_egresos4)
```
:::

## Composición de Egresos

::: panel-tabset
### Guanajuato
```{r}
#| code-fold: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: "center"
  
ggplot(egresos_agregados |> filter(ABR_ENT =="GTO"), aes(x = ANIO_factor, y =porcentaje_anual,
       fill = CATEGORIA_PRINCIPAL)) +
  geom_col(position = "stack") +
  geom_text(aes(label = ifelse(porcentaje_anual >= 5, paste0(round(porcentaje_anual, 1), "%"), "")), 
            position = position_stack(vjust = 0.5),
            size = 4, 
            color = "white",
            fontface = "bold") +
  coord_flip() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = "Composición de Egresos de Guanajuato (2013-2023)",
    subtitle = "Porcentaje por categoría (etiquetas >5%)",
    x = "Año",
    y = "Porcentaje (%)",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE))
```

### Jalisco
```{r}
#| code-fold: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: "center"

ggplot(egresos_agregados |> filter(ABR_ENT =="JAL"), aes(x = ANIO_factor, y =porcentaje_anual,
       fill = CATEGORIA_PRINCIPAL)) +
  geom_col(position = "stack") +
  geom_text(aes(label = ifelse(porcentaje_anual >= 5, paste0(round(porcentaje_anual, 1), "%"), "")), 
            position = position_stack(vjust = 0.5),
            size = 4, 
            color = "white",
            fontface = "bold") +
  coord_flip() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = "Composición de Egresos de Jalisco (2013-2023)",
    subtitle = "Porcentaje por categoría (etiquetas >5%)",
    x = "Año",
    y = "Porcentaje (%)",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE))
```
:::

# Gastos Corrientes

A continuación, se presenta un análisis detallado de los Gastos Corrientes como componente principal de los egresos estatales en México durante el periodo 2013-2023. Inicialmente se muestra por medio de diagramas de cajas la distribución en cada estado de los porcentajes anuales de esta categoría.
```{r}
#| code-fold: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: "center"

ggplot(egresos_agregados |> filter(CATEGORIA_PRINCIPAL =="Gastos Corrientes"), 
       aes(x = reorder(ABR_ENT, porcentaje_anual, FUN = mean), y = porcentaje_anual,
       fill = ABR_ENT)) +
  geom_boxplot() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = "Distribución de Gastos Corrientes como Porcentaje de Egresos Totales (2013-2023)",
    subtitle = "Porcentaje por estado",
    x = "Estado",
    y = "Porcentaje (%)",
    fill = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "none",
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  )
```

Se realiza el análisis de varianza (ANOVA) para determinar si existen diferencias significativas en la media de los porcentajes anuales para esta categoría.
```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 6
#| fig-align: "center"

gc_estado_aov <- aov(porcentaje_anual ~ ABR_ENT, data = egresos_agregados |> filter(CATEGORIA_PRINCIPAL =="Gastos Corrientes"))

summary(gc_estado_aov)
```

# Matriz de Correlación entre Categorías de Egresos
```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 6
#| fig-align: "center"

# Seleccionar solo las columnas numéricas para correlación
variables_correlacion_egresos <- egresos_wide %>%
  dplyr::select(
    ANIO,
    Gastos_Corrientes_valor, Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_valor, Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_valor, Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_valor, Obligaciones_Financieras_porcentaje,
    Otros_Egresos_valor, Otros_Egresos_porcentaje
  )

# Calcular matriz de correlación
matriz_correlacion_egresos <- cor(variables_correlacion_egresos, use = "complete.obs")

corrplot(matriz_correlacion_egresos, 
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.8,
         addCoef.col = "black",
         number.cex = 0.7,
         title = "Matriz de Correlación - Egresos Estatales",
         mar = c(0,0,2,0))
```